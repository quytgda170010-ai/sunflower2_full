# Coraza WAF Main Configuration for EHR Gateway
# Phát hiện SQL Injection, XSS, và các tấn công web phổ biến

# ============================================
# CORE SETTINGS
# ============================================
# Bắt đầu với DetectionOnly để test, sau đó chuyển sang On
SecRuleEngine DetectionOnly

# Cho phép đọc request body
SecRequestBodyAccess On
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072

# Cho phép đọc response body (để log)
SecResponseBodyAccess Off

# ============================================
# AUDIT LOG SETTINGS - Ghi log cho SIEM
# ============================================
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABCFHZ
SecAuditLogType Serial
SecAuditLog /var/log/coraza/audit.log

# ============================================
# SQL INJECTION DETECTION RULES (Simplified CRS)
# ============================================

# Rule 942100: SQL Injection Attack Detected via libinjection
SecRule REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_HEADERS|ARGS|ARGS_NAMES|REQUEST_BODY \
    "@detectSQLi" \
    "id:942100,\
    phase:2,\
    deny,\
    capture,\
    t:none,t:utf8toUnicode,t:urlDecodeUni,t:removeNulls,\
    msg:'SQL Injection Attack Detected via libinjection',\
    logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}',\
    tag:'attack-sqli',\
    tag:'OWASP_CRS',\
    tag:'paranoia-level/1',\
    severity:'CRITICAL',\
    setvar:'tx.sql_injection_score=+%{tx.critical_anomaly_score}'"

# Rule 942110: SQL Injection Attack: Common Injection Testing Detected
SecRule REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_HEADERS|ARGS|ARGS_NAMES|REQUEST_BODY \
    "@rx (?i:(?:\b(?:(?:s(?:elect\b(?:.{1,100}?\b(?:(?:(?:length|count|top)\b.{1,100}?\bfrom)|(?:from\b.{1,100}?\bwhere))|(?:(?:trunc|round)\b.{1,100}?\bfrom))|(?:isnull|sql)\b)|(?:(?:(?:c(?:harindex|oncat)|max)\b)|hook)\b|(?:waitfor\b.{1,100}?\bdelay|or\b.{1,100}?\b=)|case\b.{1,100}?\bwhen)|union\b.{1,100}?\bselect|(?:--(?:.{1,100})?|#)\s*$|\\x(?:23|27|2d)|'[\\s\\d]*(?:\\bor\\b|=))))" \
    "id:942110,\
    phase:2,\
    deny,\
    capture,\
    t:none,t:utf8toUnicode,t:urlDecodeUni,t:removeNulls,\
    msg:'SQL Injection Attack: Common Injection Testing Detected',\
    logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}',\
    tag:'attack-sqli',\
    tag:'OWASP_CRS',\
    severity:'CRITICAL'"

# Rule 942120: SQL Injection Attack: SQL Operator Detected
SecRule REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_HEADERS|ARGS|ARGS_NAMES|REQUEST_BODY \
    "@rx (?i:(?:(?:\b(?:and|or)\b\s+(?:\d{1,10}|'[^']+')[\s]*[=<>!])|(?:\b(?:group\s+by|order\s+by|having|limit)\b)|(?:\b(?:benchmark|sleep|waitfor)\b)))" \
    "id:942120,\
    phase:2,\
    deny,\
    capture,\
    t:none,t:utf8toUnicode,t:urlDecodeUni,t:removeNulls,\
    msg:'SQL Injection Attack: SQL Operator Detected',\
    logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}',\
    tag:'attack-sqli',\
    tag:'OWASP_CRS',\
    severity:'CRITICAL'"

# Rule 942130: SQL Injection Attack: SQL Tautology Detected
SecRule REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_HEADERS|ARGS|ARGS_NAMES|REQUEST_BODY \
    "@rx (?i:(?:(?:'[^']*'|\d+)\s*(?:=|<>|!=)\s*(?:'[^']*'|\d+)|(?:1\s*=\s*1|'a'\s*=\s*'a')))" \
    "id:942130,\
    phase:2,\
    deny,\
    capture,\
    t:none,t:utf8toUnicode,t:urlDecodeUni,t:removeNulls,\
    msg:'SQL Injection Attack: SQL Tautology Detected',\
    logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}',\
    tag:'attack-sqli',\
    tag:'OWASP_CRS',\
    severity:'CRITICAL'"

# ============================================
# XSS DETECTION RULES (Simplified)
# ============================================

# Rule 941100: XSS Attack Detected via libinjection
SecRule REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_HEADERS|ARGS|ARGS_NAMES|REQUEST_BODY \
    "@detectXSS" \
    "id:941100,\
    phase:2,\
    deny,\
    capture,\
    t:none,t:utf8toUnicode,t:urlDecodeUni,t:removeNulls,t:htmlEntityDecode,\
    msg:'XSS Attack Detected via libinjection',\
    logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}',\
    tag:'attack-xss',\
    tag:'OWASP_CRS',\
    severity:'CRITICAL'"

# Rule 941110: XSS Filter - Category 1: Script Tag Vector
SecRule REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_HEADERS|ARGS|ARGS_NAMES|REQUEST_BODY \
    "@rx (?i:<script[^>]*>[\\s\\S]*?<\\/script[^>]*>|<script[^>]*>|javascript:[^>]*)" \
    "id:941110,\
    phase:2,\
    deny,\
    capture,\
    t:none,t:utf8toUnicode,t:urlDecodeUni,t:removeNulls,t:htmlEntityDecode,\
    msg:'XSS Attack Detected: Script Tag',\
    logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}',\
    tag:'attack-xss',\
    tag:'OWASP_CRS',\
    severity:'CRITICAL'"

# ============================================
# WHITELIST - Loại trừ các endpoint an toàn
# ============================================

# Health check endpoints
SecRule REQUEST_URI "@beginsWith /healthz" "id:1001,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /health" "id:1002,phase:1,pass,nolog,ctl:ruleEngine=Off"

# Static assets
SecRule REQUEST_URI "@rx \\.(?:css|js|png|jpg|gif|ico|woff|woff2|ttf|svg)$" "id:1003,phase:1,pass,nolog,ctl:ruleEngine=Off"
