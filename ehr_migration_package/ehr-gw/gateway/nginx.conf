worker_processes  auto;
error_log  /shared/nginx-logs/error.log info;

events { worker_connections 1024; }

http {
  # DNS runtime cho proxy_pass dùng biến
  resolver 127.0.0.11 ipv6=off;

  include       mime.types;
  default_type  application/octet-stream;
  sendfile      on;
  keepalive_timeout  65;
  client_max_body_size 20m;

  # Log JSON format for Stack C SIEM Dashboard
  log_format siem_json escape=json
      '{ "ts":"$time_iso8601",'
      '  "request_id":"$request_id",'
      '  "ip":"$remote_addr",'
      '  "method":"$request_method",'
      '  "uri":"$request_uri",'
      '  "status":$status,'
      '  "bytes":$bytes_sent,'
      '  "role":"$http_x_roles",'
      '  "purpose":"$http_x_purpose",'
      '  "user":"$http_x_user",'
      '  "decision":"$sent_http_x_decision" }';

  server {
    listen 80;
    server_name _;

    access_log /shared/nginx-logs/access.json siem_json;

    # Đọc ENV -> biến NGINX (phải ở level server)
    set_by_lua_block $backend   { return os.getenv("BACKEND_URL") or "http://host.docker.internal:8300" }
    set_by_lua_block $fhir_base { return os.getenv("BACKEND_FHIR_BASE") or "/apis/default/fhir" }

    # Trang test (có thể dùng index.html của bạn)
    location /tester/ {
      root /usr/local/openresty/nginx/html;
      index index.html;
    }

    # PEP bảo vệ FHIR (áp cho /fhir/)
    location /fhir/ {
      # WAF check (Input Validation - chống SQLi/XSS)
      rewrite_by_lua_file /etc/nginx/lua/waf_filter.lua;
      # OPA Authorization (Policy Decision Point)
      access_by_lua_file /etc/nginx/lua/opa_auth.lua;

      # Map sang base FHIR thực tế của OpenEMR
      rewrite ^/fhir/(.*)$ $fhir_base/$1 break;

      proxy_http_version 1.1;
      proxy_set_header Host $http_host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Request-ID $request_id;
      proxy_set_header Authorization $http_authorization;

      proxy_pass $backend;
    }

    # Internal API endpoints (server-to-server, bypass OPA)
    # These endpoints are called by WAF, gateway, and other internal services
    location /admin/internal/ {
      # No OPA check - internal endpoints only accessible from Docker network
      # Restrict to internal Docker network only
      # allow 172.16.0.0/12;  # Docker networks
      # allow 10.0.0.0/8;     # Internal networks
      # deny all;

      proxy_http_version 1.1;
      proxy_set_header Host $http_host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Request-ID $request_id;
      proxy_pass http://ehr-core:8000;
    }

    # PEP bảo vệ Admin API (áp cho /admin/)
    location /admin/ {
      # WAF check (Input Validation - chống SQLi/XSS) - CHẠY TRƯỚC
      rewrite_by_lua_file /etc/nginx/lua/waf_filter.lua;
      # OPA Authorization (Policy Decision Point) - CHẠY SAU
      access_by_lua_file /etc/nginx/lua/opa_auth.lua;
      
      # Set CORS headers in response (after backend response)
      # This ensures CORS headers are present even if backend doesn't set them
      header_filter_by_lua_block {
        -- Only set CORS if not already set (for OPTIONS, access_by_lua already set it)
        if not ngx.header["Access-Control-Allow-Origin"] then
          local origin = ngx.var.http_origin
          if origin and origin ~= "" then
            ngx.header["Access-Control-Allow-Origin"] = origin
            ngx.header["Vary"] = "Origin"
          else
            ngx.header["Access-Control-Allow-Origin"] = "*"
          end
          ngx.header["Access-Control-Allow-Methods"] = "GET, POST, PUT, PATCH, DELETE, OPTIONS"
          ngx.header["Access-Control-Allow-Headers"] = "Origin,Authorization,Content-Type,Accept,X-Requested-With,X-Roles,X-User,X-User-Id,X-Dept,X-Purpose,X-Patient-Id,X-Patient,X-Patient-Dept,X-Specialty"
          ngx.header["Access-Control-Expose-Headers"] = "X-Decision,X-Request-ID"
          ngx.header["Access-Control-Allow-Credentials"] = "true"
        end
      }
      
      # Read response body to extract patient info for logging
      body_filter_by_lua_block {
        local resp_body = ngx.arg[1]
        local eof = ngx.arg[2]
        
        -- Accumulate response body chunks
        if not ngx.ctx.response_body_chunks then
          ngx.ctx.response_body_chunks = {}
        end
        
        if resp_body and resp_body ~= "" then
          table.insert(ngx.ctx.response_body_chunks, resp_body)
        end
        
        -- On last chunk, combine all chunks
        if eof then
          if #ngx.ctx.response_body_chunks > 0 then
            ngx.ctx.response_body = table.concat(ngx.ctx.response_body_chunks)
            ngx.ctx.response_body_chunks = nil
          end
        end
      }
      
      # Log after response is complete (with response_body if available)
      log_by_lua_block {
        local cjson = require "cjson.safe"
        local http = require "resty.http"
        
        -- Get response body from context if available
        local response_body = ngx.ctx.response_body
        if response_body and string.find(ngx.var.request_uri, "/admin/patients/") and ngx.var.request_method == "GET" then
          -- Try to extract patient info from response_body
          local ok, resp_data = pcall(cjson.decode, response_body)
          if ok and resp_data and type(resp_data) == "table" then
            local patient_id = resp_data.id or resp_data.patient_id
            local patient_code = resp_data.patient_code
            local patient_name = resp_data.full_name or resp_data.patient_name or resp_data.name
            
            if patient_id or patient_code then
              -- Update log with patient info from response
              local log_payload = {
                username = ngx.ctx.username_for_log or ngx.var.http_x_user or "",
                user_id = ngx.var.http_x_user_id or ngx.var.http_x_user or "",
                role = ngx.ctx.primary_role or "",
                method = ngx.var.request_method,
                path = ngx.var.request_uri,
                uri = ngx.var.request_uri,
                purpose = ngx.var.http_x_purpose or "treatment",
                patient_id = patient_id,
                patient_code = patient_code,
                patient_name = patient_name,
                operation = "view",
                action = "View patient information",
                status = ngx.status,
                response_body = response_body
              }
              
              -- Send async log update
              ngx.timer.at(0, function(premature)
                if premature then return end
                local httpc = http.new()
                httpc:set_timeout(2000)
                local backend_url = os.getenv("EHR_CORE_URL") or "http://ehr-core:8000"
                local log_url = backend_url .. "/admin/internal/log-access"
                local res, err = httpc:request_uri(log_url, {
                  method = "POST",
                  body = cjson.encode(log_payload),
                  headers = {["Content-Type"] = "application/json"}
                })
                if not res or (res.status ~= 200 and res.status ~= 201) then
                  ngx.log(ngx.ERR, "Failed to log patient access: ", err or res.status)
                else
                  ngx.log(ngx.INFO, "Successfully logged patient access with patient info")
                end
              end)
            end
          end
        end
      }

      proxy_http_version 1.1;
      proxy_set_header Host $http_host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Request-ID $request_id;
      proxy_set_header Authorization $http_authorization;

      proxy_pass http://ehr-core:8000;
    }

    # Patient portal specific API - my-activity
    location /api/my-activity {
      # WAF check (Input Validation - chống SQLi/XSS) - CHẠY TRƯỚC
      rewrite_by_lua_file /etc/nginx/lua/waf_filter.lua;
      # OPA Authorization (Policy Decision Point) - CHẠY SAU
      access_by_lua_file /etc/nginx/lua/opa_auth.lua;
      
      proxy_http_version 1.1;
      proxy_set_header Host $http_host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Request-ID $request_id;
      proxy_set_header Authorization $http_authorization;

      proxy_pass http://ehr-core:8000;
    }

    # API endpoints for web-ui (protected by WAF + OPA)
    location /api/ {
      # WAF check (Input Validation - chống SQLi/XSS) - CHẠY TRƯỚC
      rewrite_by_lua_file /etc/nginx/lua/waf_filter.lua;
      # OPA Authorization (Policy Decision Point) - CHẠY SAU
      access_by_lua_file /etc/nginx/lua/opa_auth.lua;
      
      # Set CORS headers in response (after backend response) - chỉ set nếu chưa có
      header_filter_by_lua_block {
        -- Chỉ set CORS headers nếu chưa được set bởi access_by_lua (cho GET/POST requests)
        if not ngx.header["Access-Control-Allow-Origin"] then
          local origin = ngx.var.http_origin
          if origin and origin ~= "" then
            ngx.header["Access-Control-Allow-Origin"] = origin
            ngx.header["Vary"] = "Origin"
          else
            ngx.header["Access-Control-Allow-Origin"] = "*"
          end
          ngx.header["Access-Control-Allow-Methods"] = "GET, POST, PUT, PATCH, DELETE, OPTIONS"
          ngx.header["Access-Control-Allow-Headers"] = "Origin,Authorization,Content-Type,Accept,X-Requested-With,X-Roles,X-User,X-User-Id,X-Dept,X-Purpose,X-Patient-Id,X-Patient,X-Patient-Dept,X-Specialty"
          ngx.header["Access-Control-Expose-Headers"] = "X-Decision,X-Request-ID"
          ngx.header["Access-Control-Allow-Credentials"] = "true"
        end
      }

      proxy_http_version 1.1;
      proxy_set_header Host $http_host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Request-ID $request_id;
      proxy_set_header Authorization $http_authorization;

      proxy_pass http://siem-backend-v2:8003/;
    }

    # Patient endpoints (protected by WAF + OPA, for doctor access)
    # Map /patients/ to /admin/patients/ in backend
    location /patients/ {
      # WAF check (Input Validation - chống SQLi/XSS) - CHẠY TRƯỚC
      rewrite_by_lua_file /etc/nginx/lua/waf_filter.lua;
      # OPA Authorization (Policy Decision Point) - CHẠY SAU
      access_by_lua_file /etc/nginx/lua/opa_auth.lua;
      
      # Set CORS headers in response (after backend response)
      header_filter_by_lua_block {
        if not ngx.header["Access-Control-Allow-Origin"] then
          local origin = ngx.var.http_origin
          if origin and origin ~= "" then
            ngx.header["Access-Control-Allow-Origin"] = origin
            ngx.header["Vary"] = "Origin"
          else
            ngx.header["Access-Control-Allow-Origin"] = "*"
          end
          ngx.header["Access-Control-Allow-Methods"] = "GET, POST, PUT, PATCH, DELETE, OPTIONS"
          ngx.header["Access-Control-Allow-Headers"] = "Origin,Authorization,Content-Type,Accept,X-Requested-With,X-Roles,X-User,X-User-Id,X-Dept,X-Purpose,X-Patient-Id,X-Patient,X-Patient-Dept,X-Specialty"
          ngx.header["Access-Control-Expose-Headers"] = "X-Decision,X-Request-ID"
          ngx.header["Access-Control-Allow-Credentials"] = "true"
        end
      }

      # Rewrite /patients/ to /admin/patients/ for backend
      rewrite ^/patients/(.*)$ /admin/patients/$1 break;

      proxy_http_version 1.1;
      proxy_set_header Host $http_host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Request-ID $request_id;
      proxy_set_header Authorization $http_authorization;

      proxy_pass http://ehr-core:8000;
    }

    # Patient Portal endpoints (for patients to access their own data)
    location /patient/ {
      # WAF check (Input Validation - chống SQLi/XSS) - CHẠY TRƯỚC
      rewrite_by_lua_file /etc/nginx/lua/waf_filter.lua;
      # OPA Authorization (Policy Decision Point) - CHẠY SAU
      access_by_lua_file /etc/nginx/lua/opa_auth.lua;
      
      # Set CORS headers in response (after backend response) - chỉ set nếu chưa có
      # Lua script đã set cho OPTIONS, nhưng cần set cho GET/POST
      header_filter_by_lua_block {
        -- Chỉ set CORS headers nếu chưa được set bởi access_by_lua (cho GET/POST requests)
        if not ngx.header["Access-Control-Allow-Origin"] then
          local origin = ngx.var.http_origin
          if origin and origin ~= "" then
            ngx.header["Access-Control-Allow-Origin"] = origin
            ngx.header["Vary"] = "Origin"
          else
            ngx.header["Access-Control-Allow-Origin"] = "*"
          end
          ngx.header["Access-Control-Allow-Methods"] = "GET, POST, PUT, PATCH, DELETE, OPTIONS"
          ngx.header["Access-Control-Allow-Headers"] = "Origin,Authorization,Content-Type,Accept,X-Requested-With,X-Roles,X-User,X-User-Id,X-Dept,X-Purpose,X-Patient-Id,X-Patient,X-Patient-Dept,X-Specialty"
          ngx.header["Access-Control-Expose-Headers"] = "X-Decision,X-Request-ID"
          ngx.header["Access-Control-Allow-Credentials"] = "true"
        end
      }

      proxy_http_version 1.1;
      proxy_set_header Host $http_host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Request-ID $request_id;
      proxy_set_header Authorization $http_authorization;

      proxy_pass http://ehr-core:8000;
    }

    # Keycloak proxy (no OPA protection for auth endpoints)
    location /auth/ {
      proxy_http_version 1.1;
      proxy_set_header Host $http_host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Request-ID $request_id;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host $http_host;
      proxy_set_header X-Forwarded-Port $server_port;

      # CORS headers sẽ được xử lý bởi Keycloak hoặc có thể thêm Lua script nếu cần

      proxy_pass http://keycloak:8080/;
    }

    # Health
    location = /healthz { return 200 "ok"; }
  }
}
